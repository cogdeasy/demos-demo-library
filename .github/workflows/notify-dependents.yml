name: Notify Dependent Services

on:
  pull_request:
    types: [closed]
    branches: [main]

jobs:
  trigger-service-updates:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Devin to update dependent services
        env:
          DEVIN_API_KEY: ${{ secrets.POD_SIX }}
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          PR_TITLE="${{ github.event.pull_request.title }}"
          
          curl -X POST "https://api.devin.ai/v1/sessions" \
            -H "Authorization: Bearer ${DEVIN_API_KEY}" \
            -H "Content-Type: application/json" \
            -d "{
              \"prompt\": \"Library PR #${PR_NUMBER} (${PR_TITLE}) was merged to cogdeasy/demos-demo-library.\\n\\nYour task:\\n1. Clone cogdeasy/demos-demo-service\\n2. Update the library version in pom.xml to the latest release\\n3. Check the merged PR description for new configuration properties or feature toggles\\n4. Add any new config to application.properties (toggles disabled by default)\\n5. Run tests to verify\\n6. Create a PR titled 'chore: bump demos-demo-library'\\n\\nLibrary PR: https://github.com/cogdeasy/demos-demo-library/pull/${PR_NUMBER}\\n\\nComplete autonomously without waiting for confirmation.\"
            }"
          
          echo "Devin session triggered for service updates"
