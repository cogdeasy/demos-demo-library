name: Notify Dependent Services

on:
  pull_request:
    types: [closed]
    branches: [main]

jobs:
  trigger-service-updates:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Devin to update dependent services
        env:
          DEVIN_API_KEY: ${{ secrets.POD_SIX }}
          DEVIN_ORG_ID: ${{ secrets.DEVIN_ORG_ID }}
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_URL="https://github.com/cogdeasy/demos-demo-library/pull/${PR_NUMBER}"
          
          # Get PR body via API to avoid shell escaping issues
          PR_BODY=$(gh pr view ${PR_NUMBER} --repo cogdeasy/demos-demo-library --json body --jq '.body')
          
          SERVICES="cogdeasy/demos-demo-service"
          
          for SERVICE in $SERVICES; do
            echo "Triggering Devin for ${SERVICE}..."
            
            # Build prompt as JSON directly
            jq -n \
              --arg pr_num "$PR_NUMBER" \
              --arg pr_title "$PR_TITLE" \
              --arg pr_url "$PR_URL" \
              --arg pr_body "$PR_BODY" \
              --arg service "$SERVICE" \
              '{prompt: "A library PR was merged to cogdeasy/demos-demo-library.\n\n## Library PR Details\n- PR: #\($pr_num) - \($pr_title)\n- URL: \($pr_url)\n\n## PR Description (contains Service Update Instructions)\n\($pr_body)\n\n## Your Task for \($service)\n1. Clone \($service)\n2. Read the Service Update Instructions section above\n3. Update the library version in pom.xml to the version specified\n4. Add any new configuration properties to src/main/resources/application.properties\n5. Add any feature toggles to application.properties (disabled by default)\n6. Run mvn compile to verify\n7. Create a PR with title chore: bump demos-demo-library to [version]\n\nComplete autonomously without waiting for confirmation."}' \
              > /tmp/payload.json
            
            curl -X POST "https://api.devin.ai/v3beta1/organizations/${DEVIN_ORG_ID}/sessions" \
              -H "Authorization: Bearer ${DEVIN_API_KEY}" \
              -H "Content-Type: application/json" \
              -d @/tmp/payload.json
            
            echo ""
            echo "Devin session triggered for ${SERVICE}"
          done
